<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chunked File Upload</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 10px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 100%;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .upload-area {
        border: 3px dashed #667eea;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .upload-area:hover {
        border-color: #764ba2;
        background: #f8f9ff;
      }

      .upload-area.active {
        border-color: #764ba2;
        background: #f0f2ff;
      }

      .upload-icon {
        font-size: 48px;
        color: #667eea;
        margin-bottom: 10px;
      }

      input[type='file'] {
        display: none;
      }

      .file-info {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9ff;
        border-radius: 5px;
        display: none;
      }

      .file-info.show {
        display: block;
      }

      .file-info p {
        margin: 5px 0;
        color: #555;
      }

      .progress-container {
        margin-top: 20px;
        display: none;
      }

      .progress-container.show {
        display: block;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .upload-button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: transform 0.2s ease;
      }

      .upload-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .upload-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        display: none;
      }

      .status.show {
        display: block;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
      }

      .chunk-size-selector {
        margin: 20px 0;
      }

      .chunk-size-selector label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: bold;
      }

      .chunk-size-selector select {
        width: 100%;
        padding: 10px;
        border: 2px solid #667eea;
        border-radius: 5px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üì§ Chunked File Upload</h1>

      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">‚òÅÔ∏è</div>
        <h3>Click or drag file here</h3>
        <p style="color: #888; margin-top: 10px">Supports: JPG, PNG, GIF</p>
      </div>

      <input type="file" id="fileInput" accept=".jpg,.png,.gif" />

      <div class="chunk-size-selector">
        <label for="chunkSize">Chunk Size:</label>
        <select id="chunkSize">
          <option value="102400">100 KB</option>
          <option value="524288">512 KB</option>
          <option value="1048576" selected>1 MB</option>
          <option value="2097152">2 MB</option>
        </select>
      </div>

      <div class="file-info" id="fileInfo">
        <p><strong>File Name:</strong> <span id="fileName"></span></p>
        <p><strong>File Size:</strong> <span id="fileSize"></span></p>
        <p><strong>Total Chunks:</strong> <span id="totalChunks"></span></p>
        <p><strong>File Index:</strong> <span id="fileIndex">1</span></p>
        <p><strong>Total Files:</strong> <span id="totalFiles">1</span></p>
      </div>

      <button type="button" class="upload-button" id="uploadButton" disabled>
        Upload File
      </button>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill">0%</div>
        </div>
        <p style="text-align: center; color: #555">
          <span id="currentChunk">0</span> /
          <span id="totalChunksProgress">0</span> chunks uploaded
        </p>
      </div>

      <div class="status" id="status"></div>
    </div>

    <script>
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const uploadButton = document.getElementById('uploadButton');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const status = document.getElementById('status');
      const chunkSizeSelect = document.getElementById('chunkSize');

      let selectedFile = null;
      let currentFileIndex = 1;
      let totalFilesCount = 1;

      // Upload area click
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('active');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('active');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('active');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      // Handle file selection
      function handleFileSelect(file) {
        const allowedExtensions = ['.jpg', '.png', '.gif'];
        const fileName = file.name.toLowerCase();
        const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

        if (!allowedExtensions.includes(fileExtension)) {
          showStatus('Please select a JPG, PNG, or GIF file', 'error');
          return;
        }

        selectedFile = file;
        displayFileInfo(file);
        uploadButton.disabled = false;
        status.classList.remove('show');
      }

      // Display file information
      function displayFileInfo(file) {
        const chunkSize = parseInt(chunkSizeSelect.value);
        const totalChunks = Math.ceil(file.size / chunkSize);

        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(
          file.size,
        );
        document.getElementById('totalChunks').textContent = totalChunks;
        document.getElementById('fileIndex').textContent = currentFileIndex;
        document.getElementById('totalFiles').textContent = totalFilesCount;

        fileInfo.classList.add('show');
      }

      // Update chunk info when chunk size changes
      chunkSizeSelect.addEventListener('change', () => {
        if (selectedFile) {
          displayFileInfo(selectedFile);
        }
      });

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i]
        );
      }

      // Upload button click
      uploadButton.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!selectedFile) return;

        uploadButton.disabled = true;
        progressContainer.classList.add('show');
        status.classList.remove('show');

        try {
          await uploadFileInChunks(
            selectedFile,
            currentFileIndex,
            totalFilesCount,
          );
          showStatus('‚úì File uploaded successfully!', 'success');
          currentFileIndex++;
          document.getElementById('fileIndex').textContent = currentFileIndex;
          resetForm();
        } catch (error) {
          showStatus('‚úó Upload failed: ' + error.message, 'error');
          uploadButton.disabled = false;
        }
      });

      // Upload file in chunks
      async function uploadFileInChunks(file, fileIndex, totalFiles) {
        const chunkSize = parseInt(chunkSizeSelect.value);
        const totalChunks = Math.ceil(file.size / chunkSize);
        const workerCount = 4;
        let uploadedChunks = 0;

        document.getElementById('totalChunksProgress').textContent =
          totalChunks;

        // Per-chunk upload task
        const task = async (i) => {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          // Chunk name: filename-index
          const chunkName = `${file.name}-${i}`;

          await uploadChunk(chunk, chunkName, fileIndex, totalFiles);

          uploadedChunks++;
          const progress = (uploadedChunks / totalChunks) * 100;
          updateProgress(progress, uploadedChunks, totalChunks);
        };

        // Simple async worker pool
        let nextIndex = 0;
        const workers = Array.from(
          { length: Math.min(workerCount, totalChunks) },
          async () => {
            while (nextIndex < totalChunks) {
              const i = nextIndex++;
              await task(i);
            }
          },
        );

        await Promise.all(workers);
      }

      // Upload single chunk
      async function uploadChunk(chunk, chunkName, fileIndex, totalFiles) {
        const formData = new FormData();
        formData.append('file', chunk);
        formData.append('name', chunkName);
        formData.append('fileIndex', fileIndex.toString());
        formData.append('totalFiles', totalFiles.toString());

        const response = await fetch(
          'http://localhost:3000/user/upload/large',
          {
            method: 'POST',
            body: formData,
          },
        );

        if (!response.ok) {
          throw new Error(`Failed to upload chunk: ${chunkName}`);
        }

        return response;
      }

      // Update progress bar
      function updateProgress(percentage, current, total) {
        progressFill.style.width = percentage + '%';
        progressFill.textContent = Math.round(percentage) + '%';
        document.getElementById('currentChunk').textContent = current;
      }

      // Show status message
      function showStatus(message, type) {
        status.textContent = message;
        status.className = 'status show ' + type;
      }

      // Reset form
      function resetForm() {
        setTimeout(() => {
          selectedFile = null;
          fileInput.value = '';
          fileInfo.classList.remove('show');
          progressContainer.classList.remove('show');
          uploadButton.disabled = true;
          progressFill.style.width = '0%';
          progressFill.textContent = '0%';
        }, 2000);
      }
    </script>
  </body>
</html>
